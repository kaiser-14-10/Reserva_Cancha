{% extends 'base.html' %}
{% block title %}Reservar: {{ cancha.nombre }}{% endblock %}
{% block content %}

<h2 class="mb-4">Reservar: {{ cancha.nombre }}</h2>

<style>
.dia, .hora-box {
    padding: 10px;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    margin: 4px;
    border: 1px solid #ccc;
    border-radius: 8px;
    width: 55px;
    height: 38px;
    cursor: pointer;
    transition: 0.2s;
    font-weight: 500;
}
.dia { width: 40px; }

.dia:hover, .hora-box:hover { transform: scale(1.08); }

.bloq-dia {
    background: #ff4d4d !important;
    color: white !important;
    cursor:not-allowed;
}

.bloq-hora {
    background: #7a7a7a !important;
    color: white !important;
    cursor:not-allowed;
}

.pasado {
    opacity: 0.4;
    cursor:not-allowed;
    background:#d6d6d6 !important;
}

.hora-ocupada {
    background: #ff4d4d !important;
    color: white !important;
    cursor:not-allowed;
}

.selected {
    background: #198754 !important;
    color: white !important;
}

.horas-group { margin-top: 10px; }

.horas-title {
    font-weight: bold;
    margin-top: 15px;
    margin-bottom: 5px;
    font-size: 1.1rem;
}

#horasContainer {
    padding: 10px;
    border-radius: 8px;
    background: rgba(255,255,255,0.7);
}

#calendarioDias {
    display:flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 6px;
    background: rgba(255,255,255,0.3);
    border-radius: 8px;
}

#mesNavigator {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

#mesActual {
    font-size: 22px;
    font-weight: bold;
}

.leyenda-lineal {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin-top: 15px;
    font-size: 15px;
}

.cuadro {
    width: 16px;
    height: 16px;
    display: inline-block;
    margin-right: 5px;
    border-radius: 4px;
}

.cuadro.disponible { background: #198754; }
.cuadro.ocupada { background: #ff4d4d; }
.cuadro.bloq-hora { background: #7a7a7a; }
.cuadro.bloq-dia { background: #ff4d4d; }
</style>

<!-- NAV MESES -->
<div id="mesNavigator" class="mb-3">
    <button id="prevMes" class="btn btn-secondary">&lt; Mes anterior</button>
    <div id="mesActual"></div>
    <button id="nextMes" class="btn btn-secondary">Mes siguiente &gt;</button>
</div>

<div id="calendarioDias" class="mb-3"></div>

<!-- LEYENDA GENERAL -->
<div class="leyenda-lineal">
    <span><span class="cuadro disponible"></span> Disponible</span>
    <span><span class="cuadro bloq-dia"></span> Bloqueado/Feriado</span>
</div>

<form method="post" class="card p-4 shadow-sm mt-3">
    {% csrf_token %}
    <div class="mb-3">
        <label class="form-label fw-bold">Fecha seleccionada:</label>
        <input type="date" name="fecha" id="fecha_input" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">Horas disponibles (elige un rango):</label>

        <div id="horasContainer"></div>

        <!-- LEYENDA PARA HORAS -->
        <div class="leyenda-lineal" style="margin-top: 10px;">
            <span><span class="cuadro bloq-hora"></span> Bloqueado</span>
            <span><span class="cuadro ocupada"></span> Ocupado</span>
        </div>

        <input type="hidden" name="hora" id="hora_input" required>
    </div>

    <button type="submit" class="btn btn-success w-100">Confirmar reserva</button>
</form>

<a href="/" class="btn btn-link mt-3">Volver</a>

<script>
const horasBackend = JSON.parse('{{ horas_json|escapejs }}');
const bloqueosDias = JSON.parse('{{ bloqueos_json|escapejs }}'); 
const bloqueosHorasServer = JSON.parse('{{ bloqueos_horas_json|escapejs }}');

let horasReservadas = [];
let horasBloqueadasApi = [];

let hoy = new Date();
let mesActual = hoy.getMonth();
let anioActual = hoy.getFullYear();

let inicioSel = null;
let finSel = null;

function esHoraPasada(fechaISO, hora) {
    const ahora = new Date();
    const fechaHora = new Date(fechaISO + "T" + hora + ":00");
    return fechaHora < ahora;
}

function indexOfSlot(h){
    return [...horasBackend].sort().indexOf(h);
}

function generarDias(mes, anio) {
    const cont = document.getElementById("calendarioDias");
    cont.innerHTML = "";

    const primer = new Date(anio, mes, 1);
    const ultimo = new Date(anio, mes+1, 0);

    const hoy0 = new Date();
    hoy0.setHours(0,0,0,0);

    for (let d=1; d<=ultimo.getDate(); d++) {
        const fecha = new Date(anio, mes, d);
        const iso = fecha.toISOString().slice(0,10);

        const div = document.createElement("div");
        div.classList.add("dia");
        div.textContent = d;
        div.dataset.fecha = iso;

        if (bloqueosDias.includes(iso)) div.classList.add("bloq-dia");
        if (fecha < hoy0) div.classList.add("pasado");

        div.addEventListener("click", () => seleccionarDia(div, iso));
        cont.appendChild(div);
    }

    document.getElementById("mesActual").textContent =
        primer.toLocaleString("es-ES",{ month:"long",year:"numeric" });
}

function seleccionarDia(div, fecha) {
    if (div.classList.contains("bloq-dia") || div.classList.contains("pasado"))
        return;

    document.querySelectorAll(".dia").forEach(d => d.classList.remove("selected"));
    div.classList.add("selected");

    document.getElementById("fecha_input").value = fecha;

    inicioSel = null;
    finSel = null;
    document.getElementById("hora_input").value = "";

    cargarHoras(fecha);
}

function cargarHoras(fecha) {
    fetch(`/api/horas_ocupadas/?fecha=${fecha}&cancha={{ cancha.id }}`)
    .then(r=>r.json())
    .then(data=>{
        horasReservadas = data.ocupadas || [];
        horasBloqueadasApi = data.bloqueadas || [];
        renderizarHoras(fecha);
    })
    .catch(()=>{
        horasReservadas = [];
        horasBloqueadasApi = [];
        renderizarHoras(fecha);
    });
}

function clasificarHoras(lista){
    let manana = [], tarde = [], noche = [];
    lista.forEach(h=>{
        const hh = parseInt(h.split(":")[0]);
        if (hh < 12) manana.push(h);
        else if (hh < 18) tarde.push(h);
        else noche.push(h);
    });
    return {mañana:manana, tarde:tarde, noche:noche};
}

function renderizarHoras(fecha){
    const cont = document.getElementById("horasContainer");
    cont.innerHTML = "";

    const grupos = clasificarHoras(horasBackend);

    const bloqueosHoras = bloqueosHorasServer[fecha] || [];
    const setBloq = new Set([...bloqueosHoras, ...horasBloqueadasApi]);

    function crearGrupo(nombre, lista){
        const title = document.createElement("div");
        title.classList.add("horas-title");
        title.textContent = nombre;

        const group = document.createElement("div");
        group.classList.add("horas-group");

        lista.forEach(h=>{
            const box = document.createElement("div");
            box.classList.add("hora-box");
            box.textContent = h;
            box.dataset.hora = h;

            if (horasReservadas.includes(h))
                box.classList.add("hora-ocupada");

            else if (setBloq.has(h))
                box.classList.add("bloq-hora");

            else if (esHoraPasada(fecha, h))
                box.classList.add("pasado");

            else
                box.addEventListener("click",()=>seleccionarRango(box,fecha));

            group.appendChild(box);
        });

        cont.appendChild(title);
        cont.appendChild(group);
    }

    crearGrupo("Mañana", grupos.mañana);
    crearGrupo("Tarde", grupos.tarde);
    crearGrupo("Noche", grupos.noche);
}

function seleccionarRango(box, fecha){
    const hora = box.dataset.hora;

    if (!inicioSel || (inicioSel && finSel)) {
        inicioSel = hora;
        finSel = null;
    } else {
        const ini = indexOfSlot(inicioSel);
        const fin = indexOfSlot(hora);

        if (fin < ini) {
            finSel = inicioSel;
            inicioSel = hora;
        } else {
            finSel = hora;
        }
    }

    pintarSeleccion(fecha);
}

function pintarSeleccion(fecha){
    document.querySelectorAll(".hora-box").forEach(b=>b.classList.remove("selected"));

    if (!inicioSel) return;

    const orden = [...horasBackend].sort();
    const i1 = orden.indexOf(inicioSel);
    const i2 = finSel ? orden.indexOf(finSel) : i1;

    const bloqueosHoras = bloqueosHorasServer[fecha] || [];
    const setBloq = new Set([...bloqueosHoras, ...horasBloqueadasApi]);

    for (let i=i1; i<=i2; i++){
        const h = orden[i];
        if (horasReservadas.includes(h) || setBloq.has(h) || esHoraPasada(fecha,h)) {
            alert("El rango contiene horas NO disponibles.");
            inicioSel = null;
            finSel = null;
            document.getElementById("hora_input").value = "";
            renderizarHoras(fecha);
            return;
        }
    }

    document.querySelectorAll(".hora-box").forEach(b=>{
        const idx = orden.indexOf(b.dataset.hora);
        if (idx>=i1 && idx<=i2) b.classList.add("selected");
    });

    document.getElementById("hora_input").value =
        orden[i1] + "-" + orden[i2];
}

document.getElementById("prevMes").onclick = ()=>{
    mesActual--;
    if (mesActual<0){ mesActual=11; anioActual--; }
    generarDias(mesActual,anioActual);
};

document.getElementById("nextMes").onclick = ()=>{
    mesActual++;
    if (mesActual>11){ mesActual=0; anioActual++; }
    generarDias(mesActual,anioActual);
};

window.addEventListener("DOMContentLoaded",()=>{
    generarDias(mesActual,anioActual);

    setTimeout(()=>{
        const f = document.querySelector(".dia:not(.bloq-dia):not(.pasado)");
        if (f){
            f.classList.add("selected");
            const fecha = f.dataset.fecha;
            document.getElementById("fecha_input").value = fecha;
            cargarHoras(fecha);
        }
    },0);
});
</script>

{% endblock %}
