{% extends 'base.html' %}
{% block title %}Reservar: {{ cancha.nombre }}{% endblock %}
{% block content %}

<h2 class="mb-4">Reservar: {{ cancha.nombre }}</h2>

<style>
.dia, .hora-box {
    padding: 10px;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    margin: 4px;
    border: 1px solid #ccc;
    border-radius: 8px;
    width: 55px;
    height: 38px;
    cursor: pointer;
    transition: 0.2s;
    font-weight: 500;
}
.dia { width: 40px; }
.dia:hover, .hora-box:hover { transform: scale(1.08); }

.bloq { background: #ff4d4d; color: white; cursor:not-allowed; }
.pasado { opacity: 0.4; cursor:not-allowed; }
.limite { background: #ffaa2b; }

.selected { background: #198754; color: white !important; }

.horas-group {
    margin-top: 10px;
}

.horas-title {
    font-weight: bold;
    margin-top: 15px;
    margin-bottom: 5px;
    font-size: 1.1rem;
}

.hora-ocupada {
    background: #ff4d4d;
    color: white;
    cursor: not-allowed;
}

#horasContainer {
    padding: 10px;
    border-radius: 8px;
    background: rgba(255,255,255,0.7);
}

#mesNavigator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    align-items: center;
}
#mesNavigator button {
    cursor: pointer;
}

#calendarioDias {
    display:flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 6px;
    background: rgba(255,255,255,0.3);
    border-radius: 8px;
}
</style>

<div id="mesNavigator" class="mb-3">
    <button id="prevMes" class="btn btn-secondary">&lt; Mes anterior</button>
    <div id="mesActual" style="font-weight:bold;"></div>
    <button id="nextMes" class="btn btn-secondary">Mes siguiente &gt;</button>
</div>

<div id="calendarioDias" class="mb-3"></div>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<form method="post" class="card p-4 shadow-sm">
    {% csrf_token %}
    <div class="mb-3">
        <label class="form-label fw-bold">Fecha seleccionada:</label>
        <input type="date" name="fecha" id="fecha_input" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">Horas disponibles:</label>
        <div id="horasContainer"></div>
        <input type="hidden" name="hora" id="hora_input" required>
    </div>

    <button type="submit" class="btn btn-success w-100">Confirmar reserva</button>
</form>

<a href="/" class="btn btn-link mt-3">Volver</a>

<script>
const horasBackend = JSON.parse('{{ horas_json|safe }}');
let horasReservadas = {};
const bloqueos = JSON.parse('{{ bloqueos_json|safe }}');

let hoy = new Date();
let mesActual = hoy.getMonth();
let anioActual = hoy.getFullYear();

let horaInicioSeleccionada = null;
let horaFinSeleccionada = null;

function generarDias(mes, anio) {
    const diasContainer = document.getElementById("calendarioDias");
    diasContainer.innerHTML = "";

    const primerDia = new Date(anio, mes, 1);
    const ultimoDia = new Date(anio, mes + 1, 0);
    const hoyLimite = new Date();
    hoyLimite.setHours(0,0,0,0);

    for (let d = 1; d <= ultimoDia.getDate(); d++) {
        const fecha = new Date(anio, mes, d);
        const iso = fecha.toISOString().slice(0,10);

        const div = document.createElement("div");
        div.classList.add("dia");
        if (bloqueos.includes(iso)) div.classList.add("bloq");
        if (fecha < hoyLimite) div.classList.add("pasado");

        div.dataset.fecha = iso;
        div.textContent = d;

        div.addEventListener("click", () => seleccionarDia(div, iso));
        diasContainer.appendChild(div);
    }

    document.getElementById("mesActual").textContent =
        primerDia.toLocaleString('default', { month: 'long', year: 'numeric' });
}

function seleccionarDia(div, fecha) {
    if (div.classList.contains("bloq") || div.classList.contains("pasado")) return;

    document.querySelectorAll(".dia").forEach(d => d.classList.remove("selected"));
    div.classList.add("selected");
    document.getElementById("fecha_input").value = fecha;
    horaInicioSeleccionada = null;
    horaFinSeleccionada = null;
    cargarHoras(fecha);
}

function cargarHoras(fecha) {
    fetch(`/api/horas_ocupadas/?fecha=${fecha}&cancha={{ cancha.id }}`)
        .then(res => res.json())
        .then(data => {
            horasReservadas = data.ocupadas || [];
            renderizarHoras();
        })
        .catch(err => {
            console.error(err);
            horasReservadas = [];
            renderizarHoras();
        });
}

function clasificarHoras(lista) {
    let manana = [], tarde = [], noche = [];
    lista.forEach(h => {
        let hora = parseInt(h.split(":")[0], 10);
        if (hora < 12) manana.push(h);
        else if (hora < 18) tarde.push(h);
        else noche.push(h);
    });
    return {mañana: manana, tarde: tarde, noche: noche};
}

function renderizarHoras() {
    const cont = document.getElementById("horasContainer");
    cont.innerHTML = "";
    const grupos = clasificarHoras(horasBackend);

    function crearGrupo(titulo, lista) {
        const title = document.createElement("div");
        title.classList.add("horas-title");
        title.textContent = titulo;
        cont.appendChild(title);

        const group = document.createElement("div");
        group.classList.add("horas-group");

        lista.forEach(h => {
            const box = document.createElement("div");
            box.classList.add("hora-box");
            box.textContent = h;

            if (horasReservadas.includes(h)) {
                box.classList.add("hora-ocupada");
            } else {
                box.addEventListener("click", () => seleccionarRango(box, h));
            }

            group.appendChild(box);
        });

        cont.appendChild(group);
    }

    crearGrupo("Mañana", grupos.mañana);
    crearGrupo("Tarde", grupos.tarde);
    crearGrupo("Noche", grupos.noche);
}

function seleccionarRango(box, hora) {
    const horaInput = document.getElementById("hora_input");

    if (!horaInicioSeleccionada || (horaInicioSeleccionada && horaFinSeleccionada)) {
        horaInicioSeleccionada = hora;
        horaFinSeleccionada = null;
    } else {
        const horasOrdenadas = [...horasBackend].sort();
        const inicioIndex = horasOrdenadas.indexOf(horaInicioSeleccionada);
        const finIndex = horasOrdenadas.indexOf(hora);

        if (finIndex < inicioIndex) {
            horaFinSeleccionada = horaInicioSeleccionada;
            horaInicioSeleccionada = hora;
        } else {
            horaFinSeleccionada = hora;
        }
    }

    document.querySelectorAll(".hora-box").forEach(b => b.classList.remove("selected"));
    if (horaInicioSeleccionada) {
        const horasOrdenadas = [...horasBackend].sort();
        const inicioIndex = horasOrdenadas.indexOf(horaInicioSeleccionada);
        const finIndex = horaFinSeleccionada ? horasOrdenadas.indexOf(horaFinSeleccionada) : inicioIndex;

        for (let i = inicioIndex; i <= finIndex; i++) {
            const h = horasOrdenadas[i];
            document.querySelectorAll(".hora-box").forEach(b => {
                if (b.textContent === h && !b.classList.contains("hora-ocupada")) {
                    b.classList.add("selected");
                }
            });
        }

        horaInput.value = horaInicioSeleccionada + "-" + (horaFinSeleccionada || horaInicioSeleccionada);
    }
}

document.getElementById("prevMes").addEventListener("click", () => {
    mesActual--;
    if (mesActual < 0) { mesActual = 11; anioActual--; }
    generarDias(mesActual, anioActual);
});

document.getElementById("nextMes").addEventListener("click", () => {
    mesActual++;
    if (mesActual > 11) { mesActual = 0; anioActual++; }
    generarDias(mesActual, anioActual);
});

window.addEventListener('DOMContentLoaded', () => {
    generarDias(mesActual, anioActual);

    setTimeout(() => {
        const firstDia = document.querySelector('.dia:not(.bloq):not(.pasado)');
        if (firstDia) {
            firstDia.classList.add('selected');
            const fecha = firstDia.dataset.fecha;
            document.getElementById('fecha_input').value = fecha;
            cargarHoras(fecha);
        } else {
            document.getElementById('horasContainer').innerHTML = "<div class='text-muted'>No hay días disponibles en este mes.</div>";
        }
    }, 0);
});
</script>

{% endblock %}
